---
export const prerender = true;
---

<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@500;700&family=Fraunces:opsz,wght@9..144,500;9..144,700&family=Manrope:wght@400;500;700&display=swap" rel="stylesheet" />
    <title>Google Photos Media | Admin</title>
    <style>
      :root {
        --bg: #efe3cf;
        --card: #fff8ee;
        --text: #2b1d14;
        --muted: #7c6654;
        --line: #dcc6ac;
        --accent: #be6d37;
        --accent-2: #8a4f27;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Manrope", "Segoe UI", Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(130deg, #f3e7d4 0%, #ecd9be 45%, #e3c9a9 100%);
      }
      .wrap { width: min(1100px, calc(100% - 2rem)); margin: 1rem auto 2rem; display: grid; gap: 0.8rem; }
      .bar { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
      .bar-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
      .card { background: linear-gradient(180deg, var(--card) 0%, #f6ebdc 100%); border: 1px solid var(--line); border-radius: 16px; padding: 0.9rem; }
      h1,h2 { margin: 0 0 0.5rem; font-family: "Fraunces", Georgia, serif; }
      p { margin: 0 0 0.6rem; color: var(--muted); }
      button, .button, select {
        border: 0;
        border-radius: 999px;
        padding: 0.55rem 0.95rem;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #fff6ed;
        text-decoration: none;
        cursor: pointer;
        font-weight: 700;
      }
      select { border-radius: 10px; background: #fffaf2; color: var(--text); border: 1px solid #d7bda0; min-width: 280px; }
      .ghost { background: #fff5e8; border: 1px solid #d9b995; color: #6f3f20; }
      .status { padding: 0.65rem 0.75rem; border-radius: 10px; border: 1px solid var(--line); background: #f8ecdc; color: #5a3a22; font-weight: 700; }
      .status.error { background: #fff0ea; color: #8a3f1d; border-color: #e6bfa1; }
      .controls { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center; }
      .grid { display: grid; gap: 0.8rem; grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .tile { border: 1px solid #d8bea0; border-radius: 14px; overflow: hidden; background: #fffdf8; display: grid; }
      .tile img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; background: #f2e5d5; }
      .tile-body { padding: 0.65rem; display: grid; gap: 0.5rem; }
      .tiny { font-size: 0.78rem; color: #7c6654; word-break: break-all; }
      .tile-actions { display: flex; gap: 0.45rem; flex-wrap: wrap; }
      .log { border: 1px solid var(--line); border-radius: 10px; background: #fff6e9; padding: 0.6rem; max-height: 220px; overflow: auto; white-space: pre-wrap; font-size: 0.82rem; color: #5d4431; }
      @media (max-width: 980px) { .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
      @media (max-width: 760px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } select { min-width: 220px; } }
      @media (max-width: 520px) { .grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card bar">
        <div class="bar-actions">
          <a class="button ghost" href="/admin/">Back to Admin</a>
          <button id="loginBtn" type="button" class="ghost">Log in</button>
          <button id="logoutBtn" type="button" class="ghost">Log out</button>
        </div>
        <span id="who" class="status">Checking admin session...</span>
      </section>

      <section class="card">
        <h1>Google Photos Media Library</h1>
        <p>Browse Google Photos, use direct URLs, or import into central site storage (`/uploads/images`).</p>
        <div class="controls">
          <select id="albumSelect"></select>
          <button id="loadBtn" type="button">Load Photos</button>
          <button id="moreBtn" type="button" class="ghost">Load More</button>
        </div>
      </section>

      <section class="card">
        <div id="status" class="status">Log in and load media.</div>
        <div id="log" class="log">Media tool ready.</div>
      </section>

      <section class="grid" id="mediaGrid"></section>
    </main>

    <script src="https://unpkg.com/netlify-identity-widget@1.9.2/build/netlify-identity-widget.js"></script>
    <script>
      const whoEl = document.getElementById("who");
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const albumSelect = document.getElementById("albumSelect");
      const mediaGrid = document.getElementById("mediaGrid");
      const moreBtn = document.getElementById("moreBtn");

      let mediaPageToken = "";
      let currentAlbumId = "";

      function appendLog(message) {
        const stamp = new Date().toLocaleTimeString("en-GB", { hour12: false });
        const line = `[${stamp}] ${String(message || "")}`;
        logEl.textContent = (line + "\n" + (logEl.textContent || "")).trim();
      }

      function setStatus(message, error) {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", Boolean(error));
        appendLog(message);
      }

      async function getIdentityClient(triesLeft = 30) {
        const identity = window.netlifyIdentity;
        if (identity) return identity;
        if (triesLeft <= 0) throw new Error("Netlify Identity is unavailable.");
        await new Promise((resolve) => setTimeout(resolve, 250));
        return getIdentityClient(triesLeft - 1);
      }

      async function requireAdminToken() {
        const identity = await getIdentityClient();
        identity.init();
        const user = identity.currentUser();
        if (!user) {
          identity.open("login");
          throw new Error("Please log in as admin first.");
        }
        return user.jwt();
      }

      async function apiCall(token, payload) {
        const response = await fetch("/.netlify/functions/google-photos-media", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });

        const raw = await response.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch {}
        if (!response.ok) {
          const detail = data.error || raw || response.statusText || "Unknown error";
          throw new Error(`Request failed (${response.status}): ${String(detail).trim()}`);
        }
        return data;
      }

      function renderMedia(items, append = false) {
        if (!append) mediaGrid.innerHTML = "";
        for (const item of items || []) {
          const tile = document.createElement("article");
          tile.className = "tile";
          tile.dataset.mediaItemId = item.id;
          tile.dataset.baseUrl = item.baseUrl || "";
          tile.dataset.filename = item.filename || "photo";

          const img = document.createElement("img");
          img.src = item.baseUrl ? `${item.baseUrl}=w700-h700` : "";
          img.alt = item.filename || "Google photo";

          const body = document.createElement("div");
          body.className = "tile-body";

          const name = document.createElement("div");
          name.className = "tiny";
          name.textContent = item.filename || item.id;

          const url = document.createElement("div");
          url.className = "tiny";
          url.textContent = item.baseUrl || "";

          const actions = document.createElement("div");
          actions.className = "tile-actions";

          const copyBtn = document.createElement("button");
          copyBtn.type = "button";
          copyBtn.className = "ghost";
          copyBtn.textContent = "Use Google URL";
          copyBtn.addEventListener("click", async () => {
            const direct = item.baseUrl ? `${item.baseUrl}=d` : "";
            await navigator.clipboard.writeText(direct);
            setStatus("Copied Google photo URL to clipboard.");
          });

          const importBtn = document.createElement("button");
          importBtn.type = "button";
          importBtn.textContent = "Import to Site";
          importBtn.addEventListener("click", async () => {
            importBtn.disabled = true;
            try {
              setStatus(`Importing ${item.filename || item.id}...`);
              const token = await requireAdminToken();
              const result = await apiCall(token, {
                action: "import_media",
                mediaItemId: item.id,
              });
              const localPath = result?.imported?.publicPath || "";
              if (localPath) {
                await navigator.clipboard.writeText(localPath);
                setStatus(`Imported. Local path copied: ${localPath}`);
              } else {
                setStatus("Imported photo into site storage.");
              }
            } catch (error) {
              setStatus(String(error?.message || error), true);
            } finally {
              importBtn.disabled = false;
            }
          });

          actions.append(copyBtn, importBtn);
          body.append(name, url, actions);
          tile.append(img, body);
          mediaGrid.appendChild(tile);
        }
      }

      async function loadAlbums() {
        try {
          setStatus("Loading Google Photos albums...");
          const token = await requireAdminToken();
          const data = await apiCall(token, { action: "list_albums", pageSize: 50 });
          const albums = data.albums || [];
          albumSelect.innerHTML = "";

          const all = document.createElement("option");
          all.value = "";
          all.textContent = "All Photos";
          albumSelect.appendChild(all);

          for (const album of albums) {
            const opt = document.createElement("option");
            opt.value = album.id;
            opt.textContent = `${album.title} (${album.itemCount || 0})`;
            albumSelect.appendChild(opt);
          }

          setStatus(`Loaded ${albums.length} album(s).`);
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      }

      async function loadMedia(append = false) {
        try {
          setStatus(append ? "Loading more photos..." : "Loading photos...");
          const token = await requireAdminToken();
          const payload = {
            action: "list_media",
            albumId: currentAlbumId,
            pageSize: 30,
            ...(append && mediaPageToken ? { pageToken: mediaPageToken } : {}),
          };
          const data = await apiCall(token, payload);
          const items = data.mediaItems || [];
          mediaPageToken = data.nextPageToken || "";
          moreBtn.disabled = !mediaPageToken;
          renderMedia(items, append);
          setStatus(`Loaded ${items.length} photo(s).`);
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      }

      async function initIdentityStatus() {
        try {
          const identity = await getIdentityClient();
          identity.init();
          const user = identity.currentUser();
          if (user) {
            whoEl.textContent = user.email || "Admin logged in";
            appendLog("Identity session detected.");
          } else {
            whoEl.textContent = "Not logged in";
            appendLog("No active identity session.");
          }
        } catch (error) {
          whoEl.textContent = "Not logged in";
          setStatus(String(error?.message || error), true);
        }
      }

      document.getElementById("loginBtn")?.addEventListener("click", async () => {
        try {
          const identity = await getIdentityClient();
          identity.open("login");
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      document.getElementById("logoutBtn")?.addEventListener("click", async () => {
        try {
          const identity = await getIdentityClient();
          await identity.logout();
          whoEl.textContent = "Not logged in";
          setStatus("Logged out.");
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      document.getElementById("loadBtn")?.addEventListener("click", async () => {
        currentAlbumId = albumSelect.value || "";
        mediaPageToken = "";
        await loadMedia(false);
      });

      moreBtn?.addEventListener("click", async () => {
        if (!mediaPageToken) return;
        await loadMedia(true);
      });

      appendLog("Google Photos media page ready.");
      initIdentityStatus();
      loadAlbums();
    </script>
  </body>
</html>
