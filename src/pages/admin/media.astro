---
export const prerender = true;
---

<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@500;700&family=Fraunces:opsz,wght@9..144,500;9..144,700&family=Manrope:wght@400;500;700&display=swap" rel="stylesheet" />
    <title>Google Photos Media | Admin</title>
    <style>
      :root {
        --bg: #efe3cf;
        --card: #fff8ee;
        --text: #2b1d14;
        --muted: #7c6654;
        --line: #dcc6ac;
        --accent: #be6d37;
        --accent-2: #8a4f27;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Manrope", "Segoe UI", Arial, sans-serif;
        color: var(--text);
        background: linear-gradient(130deg, #f3e7d4 0%, #ecd9be 45%, #e3c9a9 100%);
      }
      .wrap { width: min(1100px, calc(100% - 2rem)); margin: 1rem auto 2rem; display: grid; gap: 0.8rem; }
      .bar { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
      .bar-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
      .card { background: linear-gradient(180deg, var(--card) 0%, #f6ebdc 100%); border: 1px solid var(--line); border-radius: 16px; padding: 0.9rem; }
      h1,h2 { margin: 0 0 0.5rem; font-family: "Fraunces", Georgia, serif; }
      p { margin: 0 0 0.6rem; color: var(--muted); }
      button, .button {
        border: 0;
        border-radius: 999px;
        padding: 0.55rem 0.95rem;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        color: #fff6ed;
        text-decoration: none;
        cursor: pointer;
        font-weight: 700;
      }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      .ghost { background: #fff5e8; border: 1px solid #d9b995; color: #6f3f20; }
      .status { padding: 0.65rem 0.75rem; border-radius: 10px; border: 1px solid var(--line); background: #f8ecdc; color: #5a3a22; font-weight: 700; }
      .status.error { background: #fff0ea; color: #8a3f1d; border-color: #e6bfa1; }
      .controls { display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center; }
      .tiny { font-size: 0.78rem; color: #7c6654; word-break: break-all; }
      .grid { display: grid; gap: 0.8rem; grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .tile { border: 1px solid #d8bea0; border-radius: 14px; overflow: hidden; background: #fffdf8; display: grid; }
      .tile-media { aspect-ratio: 16 / 9; display: grid; place-items: center; background: #f4e8d8; color: #74573e; font-weight: 700; }
      .tile-body { padding: 0.65rem; display: grid; gap: 0.5rem; }
      .tile-actions { display: flex; gap: 0.45rem; flex-wrap: wrap; }
      .log { border: 1px solid var(--line); border-radius: 10px; background: #fff6e9; padding: 0.6rem; max-height: 220px; overflow: auto; white-space: pre-wrap; font-size: 0.82rem; color: #5d4431; }
      @media (max-width: 980px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
      @media (max-width: 520px) { .grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card bar">
        <div class="bar-actions">
          <a class="button ghost" href="/admin/">Back to Admin</a>
          <a class="button ghost" href="/admin/media-library/">Site Images</a>
          <button id="loginBtn" type="button" class="ghost">Log in</button>
          <button id="logoutBtn" type="button" class="ghost">Log out</button>
        </div>
        <span id="who" class="status">Checking admin session...</span>
      </section>

      <section class="card">
        <h1>Google Photos Media Hub</h1>
        <p>New flow: create Picker session, open Google Picker, then import selected photos into <code>/uploads/images</code>.</p>
        <div class="controls">
          <button id="startBtn" type="button">Start Picker Session</button>
          <button id="openPickerBtn" type="button" class="ghost" disabled>Open Picker</button>
          <button id="checkBtn" type="button" class="ghost" disabled>Check Session</button>
          <button id="loadBtn" type="button" class="ghost" disabled>Load Selected</button>
          <button id="moreBtn" type="button" class="ghost" disabled>Load More</button>
        </div>
        <p id="sessionInfo" class="tiny">No active picker session.</p>
      </section>

      <section class="card">
        <div id="status" class="status">Log in and start a picker session.</div>
        <div id="log" class="log">Media tool ready.</div>
      </section>

      <section class="grid" id="mediaGrid"></section>
    </main>

    <script src="https://unpkg.com/netlify-identity-widget@1.9.2/build/netlify-identity-widget.js"></script>
    <script>
      const whoEl = document.getElementById("who");
      const statusEl = document.getElementById("status");
      const logEl = document.getElementById("log");
      const mediaGrid = document.getElementById("mediaGrid");
      const sessionInfoEl = document.getElementById("sessionInfo");

      const startBtn = document.getElementById("startBtn");
      const openPickerBtn = document.getElementById("openPickerBtn");
      const checkBtn = document.getElementById("checkBtn");
      const loadBtn = document.getElementById("loadBtn");
      const moreBtn = document.getElementById("moreBtn");

      let sessionId = "";
      let pickerUri = "";
      let mediaPageToken = "";
      let integrationConfigured = false;
      let importConfigured = false;

      function appendLog(message) {
        const stamp = new Date().toLocaleTimeString("en-GB", { hour12: false });
        const line = `[${stamp}] ${String(message || "")}`;
        logEl.textContent = (line + "\n" + (logEl.textContent || "")).trim();
      }

      function setStatus(message, error) {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", Boolean(error));
        appendLog(message);
      }

      function setupHint(missingEnv) {
        const vars = (missingEnv || []).join(", ");
        return `Google Photos Picker is not configured yet. Add these Netlify env vars and redeploy: ${vars}`;
      }

      function refreshButtons() {
        const hasSession = Boolean(sessionId);
        startBtn.disabled = !integrationConfigured;
        openPickerBtn.disabled = !integrationConfigured || !hasSession || !pickerUri;
        checkBtn.disabled = !integrationConfigured || !hasSession;
        loadBtn.disabled = !integrationConfigured || !hasSession;
        moreBtn.disabled = !integrationConfigured || !hasSession || !mediaPageToken;
      }

      function setSession(data) {
        sessionId = String(data?.id || "");
        pickerUri = String(data?.pickerUri || "");
        const mediaItemsSet = Boolean(data?.mediaItemsSet);
        const expireTime = String(data?.expireTime || "");
        sessionInfoEl.textContent = sessionId
          ? `Session: ${sessionId} | Selected: ${mediaItemsSet ? "yes" : "no"} | Expires: ${expireTime || "unknown"}`
          : "No active picker session.";
        refreshButtons();
      }

      async function getIdentityClient(triesLeft = 30) {
        const identity = window.netlifyIdentity;
        if (identity) return identity;
        if (triesLeft <= 0) throw new Error("Netlify Identity is unavailable.");
        await new Promise((resolve) => setTimeout(resolve, 250));
        return getIdentityClient(triesLeft - 1);
      }

      async function requireAdminToken() {
        const identity = await getIdentityClient();
        identity.init();
        const user = identity.currentUser();
        if (!user) {
          identity.open("login");
          throw new Error("Please log in as admin first.");
        }
        return user.jwt(true);
      }

      async function apiCall(token, payload) {
        const response = await fetch("/.netlify/functions/google-photos-media", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        });

        const raw = await response.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch {}
        if (!response.ok) {
          const missingEnv = Array.isArray(data.missingEnv) ? data.missingEnv : [];
          if (missingEnv.length) throw new Error(setupHint(missingEnv));
          const detail = data.error || raw || response.statusText || "Unknown error";
          throw new Error(`Request failed (${response.status}): ${String(detail).trim()}`);
        }
        return data;
      }

      async function checkIntegrationSetup() {
        const token = await requireAdminToken();
        const data = await apiCall(token, { action: "setup" });

        integrationConfigured = Boolean(data?.configured);
        importConfigured = Boolean(data?.importConfigured);

        if (!integrationConfigured) {
          const missing = Array.isArray(data?.missingGoogleEnv) ? data.missingGoogleEnv : [];
          setStatus(setupHint(missing), true);
          refreshButtons();
          return false;
        }

        if (!importConfigured) {
          const missingImport = Array.isArray(data?.missingImportEnv) ? data.missingImportEnv.join(", ") : "GITHUB_TOKEN, GITHUB_REPO";
          setStatus(`Picker works, but import is not configured yet. Missing: ${missingImport}`, true);
        } else {
          setStatus("Google Photos Picker configured. Start a session.");
        }

        refreshButtons();
        return true;
      }

      function renderMedia(items, append = false) {
        if (!append) mediaGrid.innerHTML = "";

        for (const item of items || []) {
          const tile = document.createElement("article");
          tile.className = "tile";

          const media = document.createElement("div");
          media.className = "tile-media";
          media.textContent = String(item.mimeType || "").startsWith("video/") ? "Video" : "Photo";

          const body = document.createElement("div");
          body.className = "tile-body";

          const name = document.createElement("div");
          name.className = "tiny";
          name.textContent = item.filename || item.id;

          const meta = document.createElement("div");
          meta.className = "tiny";
          meta.textContent = `${item.mimeType || "unknown"}${item.createTime ? ` | ${item.createTime}` : ""}`;

          const actions = document.createElement("div");
          actions.className = "tile-actions";

          const importBtn = document.createElement("button");
          importBtn.type = "button";
          importBtn.textContent = "Import to Site";
          importBtn.disabled = !importConfigured;
          importBtn.addEventListener("click", async () => {
            importBtn.disabled = true;
            try {
              setStatus(`Importing ${item.filename || item.id}...`);
              const token = await requireAdminToken();
              const result = await apiCall(token, {
                action: "import_media",
                mediaItemId: item.id,
                baseUrl: item.baseUrl,
                mimeType: item.mimeType,
                filename: item.filename,
              });
              const localPath = result?.imported?.publicPath || "";
              if (localPath) {
                await navigator.clipboard.writeText(localPath);
                setStatus(`Imported. Local path copied: ${localPath}`);
              } else {
                setStatus("Imported media into site storage.");
              }
            } catch (error) {
              setStatus(String(error?.message || error), true);
            } finally {
              importBtn.disabled = !importConfigured;
            }
          });

          actions.append(importBtn);
          body.append(name, meta, actions);
          tile.append(media, body);
          mediaGrid.appendChild(tile);
        }
      }

      async function startPickerSession() {
        setStatus("Creating picker session...");
        const token = await requireAdminToken();
        const data = await apiCall(token, { action: "create_session", maxItemCount: 200 });
        setSession(data.session || {});
        mediaPageToken = "";
        mediaGrid.innerHTML = "";
        setStatus("Picker session created. Click Open Picker and select photos.");
      }

      async function checkSession() {
        if (!sessionId) {
          setStatus("Start a picker session first.", true);
          return;
        }
        setStatus("Checking picker session...");
        const token = await requireAdminToken();
        const data = await apiCall(token, { action: "get_session", sessionId });
        setSession(data.session || {});
        if (data?.session?.mediaItemsSet) {
          setStatus("Selections detected. Click Load Selected.");
        } else {
          const poll = data?.session?.pollingConfig?.pollInterval || "";
          setStatus(`No selections yet. Complete selection in Picker and check again.${poll ? ` Suggested poll: ${poll}` : ""}`);
        }
      }

      async function loadSelected(append = false) {
        if (!sessionId) {
          setStatus("Start a picker session first.", true);
          return;
        }

        setStatus(append ? "Loading more selected items..." : "Loading selected items...");
        const token = await requireAdminToken();
        const payload = {
          action: "list_picked_media",
          sessionId,
          pageSize: 30,
          ...(append && mediaPageToken ? { pageToken: mediaPageToken } : {}),
        };
        const data = await apiCall(token, payload);
        const items = data.mediaItems || [];
        mediaPageToken = data.nextPageToken || "";
        moreBtn.disabled = !mediaPageToken;

        renderMedia(items, append);
        setStatus(`Loaded ${items.length} selected item(s).`);
      }

      async function initIdentityStatus() {
        try {
          const identity = await getIdentityClient();
          identity.init();
          const user = identity.currentUser();
          if (user) {
            whoEl.textContent = user.email || "Admin logged in";
            appendLog("Identity session detected.");
          } else {
            whoEl.textContent = "Not logged in";
            appendLog("No active identity session.");
          }
        } catch (error) {
          whoEl.textContent = "Not logged in";
          setStatus(String(error?.message || error), true);
        }
      }

      document.getElementById("loginBtn")?.addEventListener("click", async () => {
        try {
          const identity = await getIdentityClient();
          identity.open("login");
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      document.getElementById("logoutBtn")?.addEventListener("click", async () => {
        try {
          const identity = await getIdentityClient();
          await identity.logout();
          whoEl.textContent = "Not logged in";
          setStatus("Logged out.");
          integrationConfigured = false;
          importConfigured = false;
          setSession({});
          mediaPageToken = "";
          refreshButtons();
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      startBtn?.addEventListener("click", async () => {
        try {
          await startPickerSession();
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      openPickerBtn?.addEventListener("click", () => {
        if (!pickerUri) {
          setStatus("No picker URL yet. Start session first.", true);
          return;
        }
        window.open(`${pickerUri}/autoclose`, "_blank", "noopener");
        setStatus("Opened Google Picker. Make selections, then return here.");
      });

      checkBtn?.addEventListener("click", async () => {
        try {
          await checkSession();
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      loadBtn?.addEventListener("click", async () => {
        try {
          mediaPageToken = "";
          await loadSelected(false);
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      moreBtn?.addEventListener("click", async () => {
        try {
          if (!mediaPageToken) return;
          await loadSelected(true);
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      appendLog("Google Photos media page ready.");
      refreshButtons();
      (async () => {
        await initIdentityStatus();
        try {
          await checkIntegrationSetup();
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      })();
    </script>
  </body>
</html>



