---
export const prerender = true;
---

<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@500;700&family=Fraunces:opsz,wght@9..144,500;9..144,700&family=Manrope:wght@400;500;700&display=swap" rel="stylesheet" />
    <title>Site Image Library | Admin</title>
    <style>
      :root { --bg:#efe3cf; --card:#fff8ee; --text:#2b1d14; --muted:#7c6654; --line:#dcc6ac; --accent:#be6d37; --accent-2:#8a4f27; }
      * { box-sizing: border-box; }
      body { margin:0; font-family:"Manrope","Segoe UI",Arial,sans-serif; color:var(--text); background:linear-gradient(130deg,#f3e7d4 0%,#ecd9be 45%,#e3c9a9 100%); }
      .wrap { width:min(1200px,calc(100% - 2rem)); margin:1rem auto 2rem; display:grid; gap:.8rem; }
      .card { background:linear-gradient(180deg,var(--card) 0%,#f6ebdc 100%); border:1px solid var(--line); border-radius:16px; padding:.9rem; }
      .bar { display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap; }
      .bar-actions,.controls { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
      .button,button { border:0; border-radius:999px; padding:.55rem .95rem; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff6ed; text-decoration:none; cursor:pointer; font-weight:700; }
      button:disabled { opacity:.5; cursor:not-allowed; }
      .ghost { background:#fff5e8; border:1px solid #d9b995; color:#6f3f20; }
      h1 { margin:0 0 .4rem; font-family:"Fraunces",Georgia,serif; }
      p { margin:0; color:var(--muted); }
      input,select { border:1px solid #d9b995; border-radius:10px; padding:.5rem .65rem; background:#fff9f0; color:#5d4431; }
      .status { color:#5a3a22; font-weight:700; }
      .status.error { color:#8a3f1d; }
      .tiny { font-size:.78rem; color:#7c6654; word-break: break-word; }
      .grid { display:grid; gap:.9rem; grid-template-columns:repeat(3,minmax(0,1fr)); }
      .tile { border:1px solid #d8bea0; border-radius:14px; overflow:hidden; background:#fffdf8; display:grid; justify-items:center; }
      .tile img { width:min(100%, 320px); aspect-ratio:4/3; object-fit:cover; background:#f4e8d8; cursor:pointer; }
      .tile-body { width:100%; padding:.65rem; display:grid; gap:.45rem; }
      .tile-row { display:flex; justify-content:space-between; gap:.5rem; align-items:center; }
      .tile-actions { display:flex; gap:.4rem; flex-wrap:wrap; }
      .copy-btn { border:1px solid #d9b995; border-radius:999px; padding:.45rem .8rem; background:#fff5e8; color:#6f3f20; cursor:pointer; font-weight:700; }
      .delete-progress-modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(34, 18, 8, 0.45); z-index: 50; padding: 1rem; }
      .delete-progress-modal.show { display: grid; }
      .delete-progress-card { width: min(520px, 100%); background: #fff8ee; border: 1px solid var(--line); border-radius: 14px; padding: .9rem; display: grid; gap: .6rem; }
      .delete-progress-wrap { width: 100%; height: 12px; border-radius: 999px; border: 1px solid #d8bea0; background: #f4e8d8; overflow: hidden; }
      .delete-progress-bar { height: 100%; width: 0%; background: linear-gradient(135deg,var(--accent),var(--accent-2)); transition: width .2s ease; }
      .viewer-modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(20, 10, 4, 0.85); z-index: 70; padding: 1rem; }
      .viewer-modal.show { display: grid; }
      .viewer-card { width:min(1100px, 100%); max-height:95vh; overflow:auto; background:#fff8ee; border:1px solid var(--line); border-radius:14px; padding:.8rem; display:grid; gap:.7rem; }
      .viewer-top { display:flex; justify-content:space-between; align-items:center; gap:.5rem; }
      .viewer-media { width:100%; max-height:72vh; object-fit:contain; background:#f4e8d8; border-radius:10px; }
      .viewer-meta { display:grid; gap:.25rem; }
      @media (max-width:980px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
      @media (max-width:620px){ .grid{grid-template-columns:1fr;} }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card bar">
        <div class="bar-actions">
          <a class="button ghost" href="/admin/">Back to Admin</a>
          <a class="button ghost" href="/admin/media/">Google Picker</a>
          <button id="loginBtn" type="button" class="ghost">Log in</button>
          <button id="logoutBtn" type="button" class="ghost">Log out</button>
        </div>
        <span id="status" class="status">Loading image library...</span>
      </section>

      <section class="card">
        <h1>Site Image Library</h1>
        <p>Select a folder first to view images. Unassigned images are shown in <strong>Unsorted</strong>.</p>
      </section>

      <section class="card controls">
        <label for="folderFilter" class="tiny">Folder:</label>
        <select id="folderFilter"></select>
        <span id="folderSummary" class="tiny">No folder selected.</span>
      </section>

      <section class="card controls">
        <button id="refreshBtn" type="button" class="ghost">Refresh</button>
        <button id="selectAllBtn" type="button" class="ghost">Select All (Visible)</button>
        <button id="clearBtn" type="button" class="ghost">Clear</button>
        <button id="deleteSelectedBtn" type="button" class="ghost">Delete Selected</button>
        <input id="folderInput" type="text" placeholder="folder name (e.g. peak-district/2026-02)" />
        <button id="assignBtn" type="button">Assign Folder</button>
        <button id="autoBtn" type="button" class="ghost">Auto Sort (GPS + Date)</button>
      </section>

      <section class="grid" id="grid"></section>
    </main>

    <div id="deleteProgressModal" class="delete-progress-modal" aria-hidden="true">
      <div class="delete-progress-card">
        <h1 style="margin:0; font-size:1.05rem;">Deleting Images</h1>
        <div id="deleteProgressText" class="tiny">Preparing delete...</div>
        <div class="delete-progress-wrap"><div id="deleteProgressBar" class="delete-progress-bar"></div></div>
      </div>
    </div>

    <div id="viewerModal" class="viewer-modal" aria-hidden="true">
      <div class="viewer-card">
        <div class="viewer-top">
          <strong id="viewerTitle">Image Viewer</strong>
          <button id="viewerCloseBtn" type="button" class="ghost">Close</button>
        </div>
        <img id="viewerImage" class="viewer-media" alt="Full size media" />
        <div id="viewerMeta" class="viewer-meta tiny"></div>
      </div>
    </div>

    <script src="https://unpkg.com/netlify-identity-widget@1.9.2/build/netlify-identity-widget.js"></script>
    <script>
      const statusEl = document.getElementById("status");
      const gridEl = document.getElementById("grid");
      const folderInput = document.getElementById("folderInput");
      const folderFilter = document.getElementById("folderFilter");
      const folderSummary = document.getElementById("folderSummary");
      const deleteProgressModal = document.getElementById("deleteProgressModal");
      const deleteProgressText = document.getElementById("deleteProgressText");
      const deleteProgressBar = document.getElementById("deleteProgressBar");
      const viewerModal = document.getElementById("viewerModal");
      const viewerImage = document.getElementById("viewerImage");
      const viewerMeta = document.getElementById("viewerMeta");
      const viewerTitle = document.getElementById("viewerTitle");
      const selected = new Set();
      let media = [];
      let currentFolder = "Unsorted";

      function normalizeFolder(value) {
        const v = String(value || "").trim();
        return v ? v : "Unsorted";
      }

      function getFolderOptions() {
        const set = new Set(["Unsorted"]);
        for (const item of media) set.add(normalizeFolder(item.folder));
        return [...set].sort((a, b) => a.localeCompare(b));
      }

      function getVisibleMedia() {
        return media.filter((item) => normalizeFolder(item.folder) === currentFolder);
      }

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.classList.toggle("error", Boolean(isError));
      }

      function setDeleteProgress(complete, total, label) {
        const safeTotal = Math.max(1, Number(total || 0));
        const safeComplete = Math.min(safeTotal, Math.max(0, Number(complete || 0)));
        const percent = Math.round((safeComplete / safeTotal) * 100);
        if (deleteProgressText) deleteProgressText.textContent = `${label || "Deleting..."} (${safeComplete}/${safeTotal})`;
        if (deleteProgressBar) deleteProgressBar.style.width = `${percent}%`;
      }

      function showDeleteProgress(total) {
        setDeleteProgress(0, total, "Starting delete");
        deleteProgressModal?.classList.add("show");
        deleteProgressModal?.setAttribute("aria-hidden", "false");
      }

      function hideDeleteProgress() {
        deleteProgressModal?.classList.remove("show");
        deleteProgressModal?.setAttribute("aria-hidden", "true");
      }

      function openViewer(item) {
        if (!item) return;
        viewerImage.src = item.publicPath;
        viewerImage.alt = item.filename || item.publicPath || "Image";
        viewerTitle.textContent = item.filename || "Image Viewer";
        const m = item.meta || {};
        const lines = [
          `Path: ${item.publicPath}`,
          `Folder: ${normalizeFolder(item.folder)}`,
          `Date: ${m.createTime || "unknown"}`,
          `GPS: ${m.latitude ?? "?"}, ${m.longitude ?? "?"}`,
        ];
        viewerMeta.innerHTML = lines.map((line) => `<div>${line}</div>`).join("");
        viewerModal.classList.add("show");
        viewerModal.setAttribute("aria-hidden", "false");
      }

      function closeViewer() {
        viewerModal.classList.remove("show");
        viewerModal.setAttribute("aria-hidden", "true");
      }

      async function getIdentityClient(triesLeft = 30) {
        const identity = window.netlifyIdentity;
        if (identity) return identity;
        if (triesLeft <= 0) throw new Error("Netlify Identity is unavailable.");
        await new Promise((resolve) => setTimeout(resolve, 250));
        return getIdentityClient(triesLeft - 1);
      }

      async function requireAdminToken() {
        const identity = await getIdentityClient();
        identity.init();
        const user = identity.currentUser();
        if (!user) {
          identity.open("login");
          throw new Error("Please log in as admin first.");
        }
        return user.jwt(true);
      }

      async function apiCall(payload) {
        const token = await requireAdminToken();
        const response = await fetch("/.netlify/functions/google-photos-media", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
          body: JSON.stringify(payload),
        });
        const raw = await response.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch {}
        if (!response.ok) {
          const detail = data.error || raw || response.statusText || "Unknown error";
          throw new Error(`Request failed (${response.status}): ${String(detail).trim()}`);
        }
        return data;
      }

      function getSelectedPaths() {
        return [...selected].filter(Boolean);
      }

      function renderFolderFilter() {
        const folders = getFolderOptions();
        if (!folders.includes(currentFolder)) currentFolder = "Unsorted";
        folderFilter.innerHTML = folders.map((f) => `<option value="${f}">${f}</option>`).join("");
        folderFilter.value = currentFolder;
      }

      function render() {
        gridEl.innerHTML = "";
        const visible = getVisibleMedia();
        folderSummary.textContent = `Showing ${visible.length} image(s) in ${currentFolder}.`;

        if (!visible.length) {
          gridEl.innerHTML = '<article class="card"><p>No images found in this folder.</p></article>';
          return;
        }

        for (const item of visible) {
          const tile = document.createElement("article");
          tile.className = "tile";
          tile.dataset.path = item.publicPath;

          const img = document.createElement("img");
          img.src = item.publicPath;
          img.alt = item.filename || item.publicPath;
          img.loading = "lazy";
          img.addEventListener("click", () => openViewer(item));

          const body = document.createElement("div");
          body.className = "tile-body";

          const topRow = document.createElement("div");
          topRow.className = "tile-row";
          const check = document.createElement("input");
          check.type = "checkbox";
          check.checked = selected.has(item.publicPath);
          check.addEventListener("change", () => {
            if (check.checked) selected.add(item.publicPath);
            else selected.delete(item.publicPath);
            setStatus(`${selected.size} selected.`);
          });

          const folder = document.createElement("span");
          folder.className = "tiny";
          folder.textContent = `Folder: ${normalizeFolder(item.folder)}`;
          topRow.append(check, folder);

          const name = document.createElement("div");
          name.className = "tiny";
          name.textContent = item.filename || "(unnamed)";

          const path = document.createElement("div");
          path.className = "tiny";
          path.textContent = item.publicPath;

          const meta = document.createElement("div");
          meta.className = "tiny";
          const m = item.meta || {};
          meta.textContent = `Date: ${m.createTime || "unknown"} | GPS: ${m.latitude ?? "?"}, ${m.longitude ?? "?"}`;

          const actions = document.createElement("div");
          actions.className = "tile-actions";

          const copyBtn = document.createElement("button");
          copyBtn.type = "button";
          copyBtn.className = "copy-btn";
          copyBtn.textContent = "Copy Path";
          copyBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(item.publicPath);
              setStatus(`Copied: ${item.publicPath}`);
            } catch {
              setStatus("Copy failed. Please copy manually.", true);
            }
          });

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "ghost";
          deleteBtn.textContent = "Delete";
          deleteBtn.addEventListener("click", async () => {
            const yes = window.confirm(`Delete ${item.publicPath} from the site image library?`);
            if (!yes) return;
            try {
              setStatus(`Deleting ${item.publicPath}...`);
              await apiCall({ action: "delete_site_media", publicPath: item.publicPath });
              selected.delete(item.publicPath);
              media = media.filter((row) => row.publicPath !== item.publicPath);
              renderFolderFilter();
              render();
              setStatus(`Deleted: ${item.publicPath}`);
            } catch (error) {
              setStatus(String(error?.message || error), true);
            }
          });

          actions.append(copyBtn, deleteBtn);
          body.append(topRow, name, path, meta, actions);
          tile.append(img, body);
          gridEl.appendChild(tile);
        }
      }

      async function loadLibrary() {
        setStatus("Loading image library...");
        const data = await apiCall({ action: "list_site_media" });
        media = Array.isArray(data.media) ? data.media : [];
        selected.clear();
        renderFolderFilter();
        render();
        setStatus(`Loaded ${media.length} image(s).`);
      }

      async function assignFolder() {
        const items = getSelectedPaths();
        const folder = String(folderInput.value || "").trim();
        if (!folder) {
          setStatus("Enter a folder name first.", true);
          return;
        }
        if (items.length === 0) {
          setStatus("Select one or more images first.", true);
          return;
        }
        setStatus(`Assigning ${items.length} image(s) to ${folder}...`);
        await apiCall({ action: "set_groups", items, folder });
        await loadLibrary();
      }

      async function autoSort() {
        const items = getSelectedPaths();
        if (items.length === 0) {
          setStatus("Select one or more images first.", true);
          return;
        }
        setStatus(`Auto-sorting ${items.length} image(s) by GPS/date...`);
        const data = await apiCall({ action: "auto_group", items });
        await loadLibrary();
        setStatus(`Auto-sort complete. Updated ${Number(data.updated || 0)} image(s).`);
      }

      async function deleteSelected() {
        const items = getSelectedPaths();
        if (items.length === 0) {
          setStatus("Select one or more images first.", true);
          return;
        }
        const yes = window.confirm(`Delete ${items.length} selected image(s) from the site image library?`);
        if (!yes) return;

        let deleted = 0;
        showDeleteProgress(items.length);
        try {
          for (let i = 0; i < items.length; i += 1) {
            const publicPath = items[i];
            setDeleteProgress(i, items.length, `Deleting ${publicPath}`);
            setStatus(`Deleting ${publicPath}...`);
            await apiCall({ action: "delete_site_media", publicPath });
            selected.delete(publicPath);
            media = media.filter((row) => row.publicPath !== publicPath);
            deleted += 1;
            setDeleteProgress(i + 1, items.length, `Deleted ${publicPath}`);
          }
        } finally {
          hideDeleteProgress();
        }

        renderFolderFilter();
        render();
        setStatus(`Deleted ${deleted} selected image(s).`);
      }

      const handleDeleteSelectedClick = async (event) => {
        if (event) event.preventDefault();
        setStatus(`Delete Selected clicked (${selected.size} selected).`);
        try {
          await deleteSelected();
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      };

      document.getElementById("refreshBtn")?.addEventListener("click", async () => {
        try { await loadLibrary(); } catch (error) { setStatus(String(error?.message || error), true); }
      });

      folderFilter?.addEventListener("change", () => {
        currentFolder = normalizeFolder(folderFilter.value);
        render();
      });

      document.getElementById("selectAllBtn")?.addEventListener("click", () => {
        for (const item of getVisibleMedia()) selected.add(item.publicPath);
        render();
        setStatus(`${selected.size} selected.`);
      });

      document.getElementById("clearBtn")?.addEventListener("click", () => {
        selected.clear();
        render();
        setStatus("Selection cleared.");
      });

      document.getElementById("deleteSelectedBtn")?.addEventListener("click", handleDeleteSelectedClick);

      document.addEventListener("click", async (event) => {
        const btn = event.target?.closest?.("#deleteSelectedBtn");
        if (!btn) return;
        await handleDeleteSelectedClick(event);
      });

      document.getElementById("assignBtn")?.addEventListener("click", async () => {
        try { await assignFolder(); } catch (error) { setStatus(String(error?.message || error), true); }
      });

      document.getElementById("autoBtn")?.addEventListener("click", async () => {
        try { await autoSort(); } catch (error) { setStatus(String(error?.message || error), true); }
      });

      document.getElementById("loginBtn")?.addEventListener("click", async () => {
        try {
          const identity = await getIdentityClient();
          identity.open("login");
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      document.getElementById("logoutBtn")?.addEventListener("click", async () => {
        try {
          const identity = await getIdentityClient();
          await identity.logout();
          media = [];
          selected.clear();
          renderFolderFilter();
          render();
          setStatus("Logged out.");
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      });

      document.getElementById("viewerCloseBtn")?.addEventListener("click", closeViewer);
      viewerModal?.addEventListener("click", (event) => {
        if (event.target === viewerModal) closeViewer();
      });

      (async () => {
        try {
          const identity = await getIdentityClient();
          identity.init();
          const user = identity.currentUser();
          if (!user) {
            setStatus("Please log in as admin first.", true);
            return;
          }
          await loadLibrary();
        } catch (error) {
          setStatus(String(error?.message || error), true);
        }
      })();
    </script>
  </body>
</html>
