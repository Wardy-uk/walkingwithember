---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getAllWalks, getPublishedWalks, getRegions, getSiteSettings } from "../lib/content";

const settings = await getSiteSettings();
const regions = await getRegions();
const publishedWalks = await getPublishedWalks();
const draftWalks = (await getAllWalks()).filter((walk) => walk.data.draft).slice(0, 3);
const walks = publishedWalks.slice(0, 3);
const mastheadImage = settings.homepage?.mastheadImage || "https://commons.wikimedia.org/wiki/Special:FilePath/Peak%20District.JPG";
const galleryImages = (settings.homepage?.galleryImages || []).filter(Boolean).slice(0, 3);
---

<BaseLayout
  title={`${settings.siteName} | Home`}
  description="UK hillwalking and mountain routes with dog-focused trail notes."
  regions={regions}
  siteName={settings.siteName}
  tagline={settings.tagline}
>
  <section class="v2-hero">
    <img src={mastheadImage} alt="Walking with Ember mountain hero" />
    <div class="v2-hero-overlay">
      <p>Walking with Ember</p>
      <h1>UK hillwalking and mountain days with your trusty dog.</h1>
      <a class="button" href="/walks/">Explore Routes</a>
    </div>
  </section>

  <section class="container v2-section">
    <div class="v2-section-head">
      <h2>Flagship Routes</h2>
      <a href="/walks/">View all walks</a>
    </div>
    {walks.length > 0 ? (
      <div class="v2-route-grid">
        {walks.map((walk) => (
          <article class="v2-route-card">
            <a href={`/walks/${walk.slug}/`}>
              <img src={walk.data.heroImage} alt={walk.data.title} loading="lazy" />
            </a>
            <div>
              <h3><a href={`/walks/${walk.slug}/`}>{walk.data.title}</a></h3>
              <p>{walk.data.location} · {walk.data.distance} mi · {walk.data.difficulty}</p>
            </div>
          </article>
        ))}
      </div>
    ) : (
      <article id="noPublishedRoutes" class="card">
        <p>No published walks yet. Draft routes will appear here after you publish them.</p>
      </article>
    )}

    {draftWalks.length > 0 && (
      <section class="admin-draft-only hidden">
        <article class="card">
          <p><strong>Admin preview:</strong> showing draft walks.</p>
        </article>
        <div class="v2-route-grid">
          {draftWalks.map((walk) => (
            <article class="v2-route-card" style="outline:2px dashed #be6d37; outline-offset:2px;">
              <a href={`/admin/#/collections/walks/entries/${walk.slug}`} target="_blank" rel="noreferrer">
                <img src={walk.data.heroImage} alt={walk.data.title} loading="lazy" />
              </a>
              <div>
                <h3><a href={`/admin/#/collections/walks/entries/${walk.slug}`} target="_blank" rel="noreferrer">{walk.data.title}</a></h3>
                <p>{walk.data.location} · {walk.data.distance} mi · {walk.data.difficulty} · Draft</p>
              </div>
            </article>
          ))}
        </div>
      </section>
    )}
  </section>

  <section class="container v2-ethos">
    <article>
      <h2>Dog-First Trail Ethos</h2>
      <p>
        Every route is logged with practical mountain detail and real dog handling context:
        livestock risk, lead-sensitive ground, weather exposure, parking access, and route backups.
      </p>
      <a class="button ghost-dark" href="/blog/">Read trail stories</a>
    </article>
    <div class="v2-image-stack">
      {(galleryImages.length > 0 ? galleryImages : ["https://commons.wikimedia.org/wiki/Special:FilePath/Peak%20district%2012.jpg"]).map((image, idx) => (
        <img src={image} alt={`Walking with Ember gallery ${idx + 1}`} loading="lazy" />
      ))}
    </div>
  </section>

  <script is:inline>
    const draftBlocks = Array.from(document.querySelectorAll(".admin-draft-only"));
    const noPublished = document.getElementById("noPublishedRoutes");

    function revealAdminDrafts() {
      draftBlocks.forEach((el) => el.classList.remove("hidden"));
      if (noPublished) noPublished.classList.add("hidden");
    }

    if (window.netlifyIdentity) {
      try {
        window.netlifyIdentity.init();
        if (window.netlifyIdentity.currentUser()) revealAdminDrafts();
        window.netlifyIdentity.on("login", revealAdminDrafts);
      } catch {}
    }
  </script>
</BaseLayout>
