---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getPublishedWalks, getRegions, getSiteSettings } from "../../lib/content";

const settings = await getSiteSettings();
const regions = await getRegions();
const walks = await getPublishedWalks();
const tagOptions = Array.from(new Set(walks.flatMap((w) => w.data.tags))).sort((a, b) => a.localeCompare(b));
---

<BaseLayout
  title={`${settings.siteName} | Walks`}
  description="Browse walk routes by distance, difficulty, region, and dog-friendly options."
  regions={regions}
  siteName={settings.siteName}
  tagline={settings.tagline}
>
  <div class="container page-grid">
    <section class="hero">
      <h1>Walks</h1>
      <p>Use filters to find routes by region, distance, difficulty, tags, and dog-friendly options.</p>
    </section>

    <section class="card page-grid">
      <div class="filters" aria-label="Walk filters">
        <label>
          Search
          <input id="filter-search" type="search" placeholder="Search title or location" />
        </label>
        <label>
          Distance
          <select id="filter-distance">
            <option value="">Any</option>
            <option value="short">Up to 5 mi</option>
            <option value="medium">5 to 10 mi</option>
            <option value="long">Over 10 mi</option>
          </select>
        </label>
        <label>
          Difficulty
          <select id="filter-difficulty">
            <option value="">Any</option>
            <option value="Easy">Easy</option>
            <option value="Moderate">Moderate</option>
            <option value="Hard">Hard</option>
          </select>
        </label>
        <label>
          Region
          <select id="filter-region">
            <option value="">Any</option>
            {regions.map((region) => <option value={region}>{region}</option>)}
          </select>
        </label>
        <label>
          Dog-friendly
          <select id="filter-dog">
            <option value="">Any</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </label>
        <label>
          Tag
          <select id="filter-tag">
            <option value="">Any</option>
            {tagOptions.map((tag) => <option value={tag}>{tag}</option>)}
          </select>
        </label>
      </div>

      <p id="walk-count" class="muted"></p>

      <div id="walk-grid" class="card-grid">
        {walks.map((walk) => (
          <article
            class="entry-card walk-card"
            data-title={walk.data.title}
            data-location={walk.data.location}
            data-distance={walk.data.distance}
            data-difficulty={walk.data.difficulty}
            data-region={walk.data.region}
            data-dog={walk.data.dogFriendly ? "yes" : "no"}
            data-tags={walk.data.tags.join(",")}
          >
            <a href={`/walks/${walk.slug}/`}>
              <img src={walk.data.heroImage} alt={walk.data.title} loading="lazy" />
            </a>
            <div class="entry-card-body">
              <h2><a href={`/walks/${walk.slug}/`}>{walk.data.title}</a></h2>
              <p class="muted">{walk.data.location} · {walk.data.distance} mi · {walk.data.difficulty}</p>
              <p>{walk.data.summary}</p>
              <ul class="chip-list">
                <li class="chip">{walk.data.region}</li>
                {walk.data.tags.slice(0, 2).map((tag) => <li class="chip">{tag}</li>)}
              </ul>
            </div>
          </article>
        ))}
      </div>
    </section>
  </div>

  <script is:inline>
    const cards = Array.from(document.querySelectorAll(".walk-card"));
    const count = document.getElementById("walk-count");
    const search = document.getElementById("filter-search");
    const distance = document.getElementById("filter-distance");
    const difficulty = document.getElementById("filter-difficulty");
    const region = document.getElementById("filter-region");
    const dog = document.getElementById("filter-dog");
    const tag = document.getElementById("filter-tag");

    const params = new URLSearchParams(window.location.search);
    if (params.get("region") && region) {
      region.value = params.get("region");
    }

    function filterCards() {
      const query = (search?.value || "").toLowerCase();
      let visible = 0;

      for (const card of cards) {
        const title = (card.dataset.title || "").toLowerCase();
        const location = (card.dataset.location || "").toLowerCase();
        const matchSearch = !query || title.includes(query) || location.includes(query);

        const miles = Number(card.dataset.distance || "0");
        const distValue = distance?.value || "";
        let matchDistance = true;
        if (distValue === "short") matchDistance = miles <= 5;
        if (distValue === "medium") matchDistance = miles > 5 && miles <= 10;
        if (distValue === "long") matchDistance = miles > 10;

        const matchDifficulty = !difficulty?.value || card.dataset.difficulty === difficulty.value;
        const matchRegion = !region?.value || card.dataset.region === region.value;
        const matchDog = !dog?.value || card.dataset.dog === dog.value;
        const matchTag = !tag?.value || (card.dataset.tags || "").split(",").includes(tag.value);

        const show = matchSearch && matchDistance && matchDifficulty && matchRegion && matchDog && matchTag;
        card.style.display = show ? "" : "none";
        if (show) visible += 1;
      }
      if (count) count.textContent = `${visible} walk${visible === 1 ? "" : "s"} found`;
    }

    [search, distance, difficulty, region, dog, tag].forEach((el) => el?.addEventListener("input", filterCards));
    filterCards();
  </script>
</BaseLayout>
