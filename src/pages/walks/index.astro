---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getAllWalks, getRegions, getSiteSettings } from "../../lib/content";

const settings = await getSiteSettings();
const regions = await getRegions();
const walks = await getAllWalks();
const publishedWalks = walks.filter((walk) => !walk.data.draft);
const draftWalks = walks.filter((walk) => walk.data.draft);
const tagOptions = Array.from(new Set(walks.flatMap((w) => w.data.tags))).sort((a, b) => a.localeCompare(b));
---

<BaseLayout
  title={`${settings.siteName} | Walks`}
  description="Browse walk routes by distance, difficulty, region, and dog-friendly options."
  regions={regions}
  siteName={settings.siteName}
  tagline={settings.tagline}
>
  <div class="container page-grid">
    <section class="hero">
      <h1>Walks</h1>
      <p>Route finder for UK hills and mountains. Filter by region, distance, difficulty, tags, and dog access.</p>
    </section>

    <section class="card route-planning-grid">
      <article>
        <h2>Before You Set Off</h2>
        <ul>
          <li>Check weather and wind exposure for high ground.</li>
          <li>Download GPX and carry offline mapping backup.</li>
          <li>Plan parking and daylight margins, especially in winter.</li>
        </ul>
      </article>
      <article>
        <h2>Dog Trail Intelligence</h2>
        <ul>
          <li>Filter by dog-friendly routes only.</li>
          <li>Use route notes for livestock and lead-sensitive sections.</li>
          <li>Carry water, paw towel, and spare lead.</li>
        </ul>
      </article>
    </section>

    <section class="card page-grid">
      <div class="filters" aria-label="Walk filters">
        <label>
          Search
          <input id="filter-search" type="search" placeholder="Search title or location" />
        </label>
        <label>
          Distance
          <select id="filter-distance">
            <option value="">Any</option>
            <option value="short">Up to 5 mi</option>
            <option value="medium">5 to 10 mi</option>
            <option value="long">Over 10 mi</option>
          </select>
        </label>
        <label>
          Difficulty
          <select id="filter-difficulty">
            <option value="">Any</option>
            <option value="Easy">Easy</option>
            <option value="Moderate">Moderate</option>
            <option value="Hard">Hard</option>
          </select>
        </label>
        <label>
          Region
          <select id="filter-region">
            <option value="">Any</option>
            {regions.map((region) => <option value={region}>{region}</option>)}
          </select>
        </label>
        <label>
          Dog-friendly
          <select id="filter-dog">
            <option value="">Any</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </label>
        <label>
          Tag
          <select id="filter-tag">
            <option value="">Any</option>
            {tagOptions.map((tag) => <option value={tag}>{tag}</option>)}
          </select>
        </label>
      </div>

      <p id="walk-count" class="muted"></p>

      <div id="walk-grid" class="card-grid">
        {publishedWalks.map((walk) => (
          <article
            class:list={["entry-card", "walk-card"]}
            data-title={walk.data.title}
            data-location={walk.data.location}
            data-distance={walk.data.distance}
            data-difficulty={walk.data.difficulty}
            data-region={walk.data.region}
            data-dog={walk.data.dogFriendly ? "yes" : "no"}
            data-tags={walk.data.tags.join(",")}
            data-draft="no"
            data-content-path={`src/content/walks/${walk.slug}.md`}
            data-entry-type="walk"
            data-entry-title={walk.data.title}
          >
            <div class="entry-admin-controls admin-card-control hidden">
              <button type="button" class="entry-admin-delete" data-admin-action="delete" aria-label={`Delete ${walk.data.title}`}>×</button>
              <button type="button" class="entry-admin-archive" data-admin-action="archive">Archive</button>
            </div>
            <a href={`/walks/${walk.slug}/`}>
              <img src={walk.data.heroImage} alt={walk.data.title} loading="lazy" />
            </a>
            <div class="entry-card-body">
              <h2><a href={`/walks/${walk.slug}/`}>{walk.data.title}</a></h2>
              <p class="muted">{walk.data.location} · {walk.data.distance} mi · {walk.data.difficulty}</p>
              <p>{walk.data.summary}</p>
              <ul class="chip-list">
                <li class="chip">{walk.data.region}</li>
                {walk.data.tags.slice(0, 2).map((tag) => <li class="chip">{tag}</li>)}
              </ul>
            </div>
          </article>
        ))}
      </div>

      {draftWalks.length > 0 && (
        <section id="draft-section" class="card draft-section hidden">
          <h2>Draft Walks (Admin)</h2>
          <p class="muted">Visible only when logged in as admin.</p>
          <div id="draft-grid" class="card-grid">
            {draftWalks.map((walk) => (
              <article
                class:list={["entry-card", "walk-card", "draft-card", "admin-draft-only", "hidden"]}
                data-title={walk.data.title}
                data-location={walk.data.location}
                data-distance={walk.data.distance}
                data-difficulty={walk.data.difficulty}
                data-region={walk.data.region}
                data-dog={walk.data.dogFriendly ? "yes" : "no"}
                data-tags={walk.data.tags.join(",")}
                data-draft="yes"
                data-content-path={`src/content/walks/${walk.slug}.md`}
                data-entry-type="walk"
                data-entry-title={walk.data.title}
              >
                <div class="entry-admin-controls admin-card-control hidden">
                  <button type="button" class="entry-admin-delete" data-admin-action="delete" aria-label={`Delete ${walk.data.title}`}>×</button>
                  <button type="button" class="entry-admin-archive" data-admin-action="archive">Archive</button>
                </div>
                <a href={`/preview/walks/${walk.slug}/`} target="_blank" rel="noreferrer">
                  <img src={walk.data.heroImage} alt={walk.data.title} loading="lazy" />
                </a>
                <div class="entry-card-body">
                  <h2><a href={`/preview/walks/${walk.slug}/`} target="_blank" rel="noreferrer">{walk.data.title}</a></h2>
                  <p class="muted">{walk.data.location} · {walk.data.distance} mi · {walk.data.difficulty} · Draft</p>
                  <p>{walk.data.summary}</p>
                  <ul class="chip-list">
                    <li class="chip">Draft</li>
                    <li class="chip">{walk.data.region}</li>
                    {walk.data.tags.slice(0, 1).map((tag) => <li class="chip">{tag}</li>)}
                  </ul>
                </div>
              </article>
            ))}
          </div>
        </section>
      )}
    </section>
  </div>

  <script is:inline>
    const cards = Array.from(document.querySelectorAll(".walk-card"));
    const count = document.getElementById("walk-count");
    const draftSection = document.getElementById("draft-section");
    const search = document.getElementById("filter-search");
    const distance = document.getElementById("filter-distance");
    const difficulty = document.getElementById("filter-difficulty");
    const region = document.getElementById("filter-region");
    const dog = document.getElementById("filter-dog");
    const tag = document.getElementById("filter-tag");
    const adminControls = Array.from(document.querySelectorAll(".admin-card-control"));

    const params = new URLSearchParams(window.location.search);
    if (params.get("region") && region) {
      region.value = params.get("region");
    }

    let showDraftsForAdmin = false;

    function filterCards() {
      const query = (search?.value || "").toLowerCase();
      let visible = 0;
      let visibleDrafts = 0;

      for (const card of cards) {
        const title = (card.dataset.title || "").toLowerCase();
        const location = (card.dataset.location || "").toLowerCase();
        const matchSearch = !query || title.includes(query) || location.includes(query);

        const miles = Number(card.dataset.distance || "0");
        const distValue = distance?.value || "";
        let matchDistance = true;
        if (distValue === "short") matchDistance = miles <= 5;
        if (distValue === "medium") matchDistance = miles > 5 && miles <= 10;
        if (distValue === "long") matchDistance = miles > 10;

        const matchDifficulty = !difficulty?.value || card.dataset.difficulty === difficulty.value;
        const matchRegion = !region?.value || card.dataset.region === region.value;
        const matchDog = !dog?.value || card.dataset.dog === dog.value;
        const matchTag = !tag?.value || (card.dataset.tags || "").split(",").includes(tag.value);

        const isDraft = card.dataset.draft === "yes";
        const showByRole = !isDraft || showDraftsForAdmin;
        const show = showByRole && matchSearch && matchDistance && matchDifficulty && matchRegion && matchDog && matchTag;
        card.style.display = show ? "" : "none";
        if (show) {
          visible += 1;
          if (isDraft) visibleDrafts += 1;
        }
      }

      if (draftSection) {
        const showDraftBlock = showDraftsForAdmin && visibleDrafts > 0;
        draftSection.classList.toggle("hidden", !showDraftBlock);
      }
      if (count) count.textContent = `${visible} walk${visible === 1 ? "" : "s"} found`;
    }

    function identitySnapshot(user) {
      const appMeta = user?.app_metadata || {};
      const identities = Array.isArray(appMeta.identities) ? appMeta.identities : [];
      const providers = identities.map((x) => String(x?.provider || "").trim()).filter(Boolean);
      const providerSet = Array.from(new Set([String(appMeta.provider || "").trim(), ...providers].filter(Boolean)));
      return {
        provider: providerSet.join(", "),
      };
    }

    function isGithubIdentity(user) {
      const d = identitySnapshot(user);
      return String(d.provider || "").toLowerCase().split(",").map((x) => x.trim()).includes("github");
    }

    async function getIdentityClient(triesLeft = 30) {
      const identity = window.netlifyIdentity;
      if (identity) return identity;
      if (triesLeft <= 0) throw new Error("Netlify Identity is unavailable.");
      await new Promise((resolve) => setTimeout(resolve, 250));
      return getIdentityClient(triesLeft - 1);
    }

    async function requireAdminToken() {
      const identity = await getIdentityClient();
      identity.init();
      const user = identity.currentUser();
      if (!user) {
        identity.open("login");
        throw new Error("Please log in as admin first.");
      }
      if (!isGithubIdentity(user)) {
        throw new Error("Use GitHub login for admin access.");
      }
      return user.jwt();
    }

    async function manageCard(card, operation) {
      const contentPath = card?.dataset?.contentPath || "";
      const entryTitle = card?.dataset?.entryTitle || "this walk";
      if (!contentPath) throw new Error("Missing content path for this item.");

      const prompt = operation === "delete"
        ? `Delete "${entryTitle}" permanently? This cannot be undone.`
        : `Archive "${entryTitle}" and move it to draft?`;
      if (!window.confirm(prompt)) return;

      const token = await requireAdminToken();
      const response = await fetch("/.netlify/functions/ai-create-post", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          action: "manage_post",
          operation,
          contentPath,
        }),
      });

      const raw = await response.text();
      let data = {};
      try { data = raw ? JSON.parse(raw) : {}; } catch {}
      if (!response.ok) {
        const detail = data.error || raw || response.statusText || "Unknown error";
        throw new Error(`Request failed (${response.status}): ${String(detail).trim()}`);
      }

      window.alert(operation === "delete" ? "Walk deleted." : "Walk archived.");
      window.location.reload();
    }

    [search, distance, difficulty, region, dog, tag].forEach((el) => el?.addEventListener("input", filterCards));

    const syncDraftsFromIdentity = (user) => {
      showDraftsForAdmin = Boolean(user && isGithubIdentity(user));
      document.body.classList.toggle("is-admin", showDraftsForAdmin);
      adminControls.forEach((el) => el.classList.toggle("hidden", !showDraftsForAdmin));
      if (draftSection) {
        draftSection.classList.toggle("hidden", !showDraftsForAdmin);
      }
      filterCards();
    };

    syncDraftsFromIdentity(window.__wwIdentityUser || null);
    window.addEventListener("ww-identity-change", (event) => {
      syncDraftsFromIdentity(event.detail?.user || null);
    });

    document.addEventListener("click", async (event) => {
      const btn = event.target.closest("[data-admin-action]");
      if (!btn) return;
      const card = btn.closest(".walk-card");
      if (!card) return;
      const operation = btn.dataset.adminAction;
      if (!operation) return;
      btn.disabled = true;
      try {
        await manageCard(card, operation);
      } catch (error) {
        window.alert(String(error?.message || error));
        btn.disabled = false;
      }
    });

    filterCards();
  </script>
</BaseLayout>






