---
import "leaflet/dist/leaflet.css";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import FlybyPanel from "../../../components/FlybyPanel.astro";
import { getAllWalks, getRegions, getSiteSettings } from "../../../lib/content";

export async function getStaticPaths() {
  const walks = await getAllWalks();
  return walks.map((walk) => ({
    params: { slug: walk.slug },
    props: { walk },
  }));
}

const { walk } = Astro.props;
const settings = await getSiteSettings();
const regions = await getRegions();
const { Content } = await walk.render();
const pageUrl = new URL(`/walks/${walk.slug}/`, Astro.site).toString();
const encodedUrl = encodeURIComponent(pageUrl);
const encodedTitle = encodeURIComponent(walk.data.title);
const mapApiKey = import.meta.env.PUBLIC_OS_MAPS_API_KEY ?? "";
const gpxUrl = walk.data.gpxDownload ?? "";
const hasGpx = Boolean(gpxUrl);
const isDraft = Boolean(walk.data.draft);
const contentPath = `src/content/walks/${walk.slug}.md`;
const liveWalkUrl = `/walks/${walk.slug}/`;
const estimatedHours = walk.data.difficulty === "Hard"
  ? Math.max(3, Math.round(walk.data.distance / 2))
  : walk.data.difficulty === "Moderate"
    ? Math.max(2, Math.round(walk.data.distance / 2.4))
    : Math.max(1, Math.round(walk.data.distance / 2.8));
---

<BaseLayout
  title={`${walk.data.title} | ${settings.siteName}`}
  description={walk.data.summary}
  regions={regions}
  siteName={settings.siteName}
  tagline={settings.tagline}
>
  <div class="container page-grid">
    <article class="card article">
      <img src={walk.data.heroImage} alt={walk.data.title} />
      <h1>{walk.data.title}</h1>
      <p class="article-meta">
        {walk.data.location} 路 {walk.data.region} 路 {walk.data.distance} mi 路 {walk.data.difficulty} 路
        {walk.data.dogFriendly ? " Dog-friendly" : " Not dog-friendly"}
      </p>
      <p>{walk.data.summary}</p>

      {isDraft && (
        <section class="card" id="draftActions" data-content-path={contentPath} data-live-url={liveWalkUrl}>
          <h2>Draft Preview</h2>
          <p>This walk is still a draft. Publish it here to make it live on the main walks pages.</p>
          <div class="actions">
            <button id="publishWalkBtn" class="button" type="button">Publish This Walk</button>
            <a id="openLiveWalkBtn" class="button ghost-dark hidden" href={liveWalkUrl}>Open Live Walk</a>
          </div>
          <p id="publishStatus" class="muted"></p>
        </section>
      )}

      <ul class="chip-list">
        {walk.data.tags.map((tag) => <li class="chip">{tag}</li>)}
      </ul>

      <section class="route-facts">
        <div><span>Distance</span><strong>{walk.data.distance} mi</strong></div>
        <div><span>Difficulty</span><strong>{walk.data.difficulty}</strong></div>
        <div><span>Estimated Time</span><strong>{estimatedHours} hrs</strong></div>
        <div><span>Dog Access</span><strong>{walk.data.dogFriendly ? "Dog-friendly" : "Lead only / restricted areas"}</strong></div>
      </section>

      <section class:list={["map-compare", hasGpx && "two-panels"]}>
        <section class="card map-card">
          <div class="flyby-head">
            <h2>Route Map</h2>
            <a
              class="button ghost-dark"
              href={walk.data.osMapsLink ?? walk.data.gpxDownload}
              target="_blank"
              rel="noreferrer"
            >
              Open In New Tab
            </a>
          </div>
          <div
            class="map-panel"
            id="map"
            data-lat={String(walk.data.routeMapLat)}
            data-lng={String(walk.data.routeMapLng)}
            data-zoom={String(walk.data.routeMapZoom)}
            data-map-api-key={mapApiKey}
            data-gpx-url={gpxUrl}
          ></div>
        </section>
        {hasGpx && (
          <FlybyPanel
            gpxUrl={gpxUrl}
            osApiKey={mapApiKey}
            autoPlay={false}
            openTabHref={`/preview/flyby/${walk.slug}/?autoplay=1`}
            showOpenTab={true}
            panelTitle="3D Flyby"
          />
        )}
      </section>

      <section class="card planning-strip">
        <div>
          <h2>Map And Navigation</h2>
          <p>Route line is drawn from this walk GPX on OS mapping where available.</p>
        </div>
        <div class="planning-links">
          {walk.data.osMapsLink && <a class="button" href={walk.data.osMapsLink} target="_blank" rel="noreferrer">Open OS Maps Route</a>}
          <a class="button ghost-dark" href={walk.data.gpxDownload} target="_blank" rel="noreferrer">Download GPX</a>
        </div>
      </section>

      <section class="card dog-panel">
        <h2>Dog Trail Checklist</h2>
        <ul>
          <li>{walk.data.dogFriendly ? "Route is suitable for dogs with normal trail control." : "Route has sensitive sections. Use close lead control."}</li>
          <li>Check livestock and ground-nesting bird signage on the day.</li>
          <li>Carry water for your dog and avoid heat stress on exposed climbs.</li>
          <li>Pack a towel and paw check kit for wet rock and boggy exits.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Route Notes</h2>
        <Content />
      </section>

      <section class="card">
        <h2>Downloads and Links</h2>
        <p><strong>Parking:</strong> {walk.data.parking}</p>
        <p><strong>Mountain weather:</strong> <a href="https://www.mwis.org.uk/" target="_blank" rel="noreferrer">MWIS forecast</a></p>
        <p><strong>General weather:</strong> <a href="https://www.metoffice.gov.uk/" target="_blank" rel="noreferrer">Met Office</a></p>
        <p><a href={walk.data.gpxDownload} target="_blank" rel="noreferrer">Download GPX</a></p>
      </section>

      <section class="card">
        <h2>Share This Walk</h2>
        <div class="share-row">
          <a class="button" href={`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`} target="_blank" rel="noreferrer">Facebook</a>
          <a class="button" href={`https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`} target="_blank" rel="noreferrer">X</a>
          <a class="button" href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`} target="_blank" rel="noreferrer">LinkedIn</a>
          <a class="button" href={`mailto:?subject=${encodedTitle}&body=${encodedUrl}`}>Email</a>
        </div>
      </section>
    </article>
  </div>

  <script type="application/ld+json" is:inline define:vars={{ walk: walk.data, pageUrl }}>
    {JSON.stringify({
      "@context": "https://schema.org",
      "@type": "TouristTrip",
      name: walk.title,
      description: walk.summary,
      url: pageUrl,
      touristType: "Walkers"
    })}
  </script>

  <script>
    import L from "leaflet";

    const mapContainer = document.getElementById("map");
    const publishBtn = document.getElementById("publishWalkBtn");
    const publishStatusEl = document.getElementById("publishStatus");
    const openLiveWalkBtn = document.getElementById("openLiveWalkBtn");
    const draftActions = document.getElementById("draftActions");
    const draftContentPath = draftActions?.dataset.contentPath || "";
    const liveUrl = draftActions?.dataset.liveUrl || "";

    const lat = Number(mapContainer?.dataset.lat || "0");
    const lng = Number(mapContainer?.dataset.lng || "0");
    const zoom = Number(mapContainer?.dataset.zoom || "11");
    const mapApiKey = mapContainer?.dataset.mapApiKey || "";
    const gpxUrl = mapContainer?.dataset.gpxUrl || "";

    function logDebug(message) {
      const ts = new Date().toLocaleTimeString("en-GB", { hour12: false });
      const line = `[${ts}] ${message}`;
      console.log(line);
    }

    function setPublishStatus(message, isError = false) {
      if (!publishStatusEl) return;
      publishStatusEl.textContent = message;
      publishStatusEl.style.color = isError ? "#8f3a2b" : "";
    }

    async function requireAdminToken() {
      const identity = window.netlifyIdentity;
      if (!identity) throw new Error("Netlify Identity is unavailable.");
      identity.init();
      const user = identity.currentUser();
      if (!user) {
        identity.open("login");
        throw new Error("Please log in as admin first.");
      }
      return user.jwt();
    }

    async function publishDraftFromPreview() {
      if (!draftContentPath) throw new Error("Missing draft content path.");
      setPublishStatus("Publishing draft...");
      if (publishBtn) publishBtn.disabled = true;
      try {
        const token = await requireAdminToken();
        const response = await fetch("/.netlify/functions/ai-create-post", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            action: "publish_draft",
            contentPath: draftContentPath,
          }),
        });

        const raw = await response.text();
        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch {}

        if (!response.ok) {
          const detail = data.error || raw || response.statusText || "Unknown error";
          throw new Error(`Publish failed (${response.status}): ${String(detail).trim()}`);
        }

        setPublishStatus("Draft published. It will appear on live pages after deploy completes.");
        if (publishBtn) {
          publishBtn.disabled = true;
          publishBtn.textContent = "Published";
        }
        if (openLiveWalkBtn && liveUrl) {
          openLiveWalkBtn.classList.remove("hidden");
        }
      } catch (error) {
        setPublishStatus(String(error?.message || error), true);
        if (publishBtn) publishBtn.disabled = false;
      }
    }

    if (publishBtn) {
      publishBtn.addEventListener("click", publishDraftFromPreview);
    }

    function showMapMessage(message) {
      if (!mapContainer) return;
      mapContainer.innerHTML = `<div style="display:grid;place-items:center;height:100%;padding:1rem;color:#7c6654;font-size:0.95rem;">${message}</div>`;
      logDebug(`UI message: ${message}`);
    }

    function extractTrackPoints(xmlText) {
      const doc = new DOMParser().parseFromString(xmlText, "application/xml");
      const points = [];
      const trk = Array.from(doc.querySelectorAll("trkpt"));
      const rte = Array.from(doc.querySelectorAll("rtept"));
      const nodes = trk.length > 0 ? trk : rte;
      for (const node of nodes) {
        const pLat = Number(node.getAttribute("lat"));
        const pLng = Number(node.getAttribute("lon"));
        if (Number.isFinite(pLat) && Number.isFinite(pLng)) points.push([pLat, pLng]);
      }
      return points;
    }

    logDebug(`Start lat=${lat} lng=${lng} zoom=${zoom} apiKey=${mapApiKey ? "yes" : "no"}`);
    logDebug(`GPX URL: ${gpxUrl || "(empty)"}`);

    if (!mapContainer) {
      logDebug("No #map container found.");
    } else {
      try {
        const map = L.map(mapContainer).setView([lat, lng], zoom);
        logDebug("Leaflet map initialized.");

        if (mapApiKey) {
          L.tileLayer("https://api.os.uk/maps/raster/v1/zxy/Outdoor_3857/{z}/{x}/{y}.png?key={accessToken}", {
            accessToken: mapApiKey,
            maxZoom: 18,
            attribution: "&copy; Ordnance Survey"
          }).addTo(map);
          logDebug("OS tile layer attached.");
        } else {
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: "&copy; OpenStreetMap contributors"
          }).addTo(map);
          logDebug("OSM tile layer attached (no API key).");
        }

        const dropFallbackMarker = () => {
          L.circleMarker([lat, lng], { radius: 5, color: "#be6d37", weight: 2, fillOpacity: 1 }).addTo(map);
          logDebug("Fallback marker rendered.");
        };

        const drawRouteFromGpx = async () => {
          if (!gpxUrl) {
            logDebug("No GPX URL available.");
            dropFallbackMarker();
            return;
          }

          try {
            logDebug(`Fetching GPX: ${gpxUrl}`);
            const response = await fetch(gpxUrl);
            logDebug(`GPX fetch status=${response.status}`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const gpxXml = await response.text();
            logDebug(`GPX size=${gpxXml.length} chars`);

            const routePoints = extractTrackPoints(gpxXml);
            logDebug(`Extracted route points=${routePoints.length}`);

            if (routePoints.length < 2) {
              logDebug("Too few GPX points; using fallback marker.");
              dropFallbackMarker();
              return;
            }

            const routeLine = L.polyline(routePoints, { color: "#be6d37", weight: 4, opacity: 0.9 }).addTo(map);
            map.fitBounds(routeLine.getBounds(), { padding: [24, 24] });
            L.circleMarker(routePoints[0], { radius: 5, color: "#1f7a1f", weight: 2, fillOpacity: 1 }).addTo(map);
            L.circleMarker(routePoints[routePoints.length - 1], { radius: 5, color: "#9e2a2a", weight: 2, fillOpacity: 1 }).addTo(map);
            logDebug("Route rendered successfully.");
          } catch (error) {
            logDebug(`GPX render error: ${error?.message || error}`);
            dropFallbackMarker();
          }
        };

        drawRouteFromGpx();
      } catch (error) {
        logDebug(`Map init error: ${error?.message || error}`);
        showMapMessage("Map failed to load on this page.");
      }
    }
  </script>
</BaseLayout>
