---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getAllWalks, getRegions, getSiteSettings } from "../../../lib/content";

export async function getStaticPaths() {
  const walks = await getAllWalks();
  return walks.map((walk) => ({
    params: { slug: walk.slug },
    props: { walk },
  }));
}

const { walk } = Astro.props;
const settings = await getSiteSettings();
const regions = await getRegions();
const { Content } = await walk.render();
const pageUrl = new URL(`/walks/${walk.slug}/`, Astro.site).toString();
const encodedUrl = encodeURIComponent(pageUrl);
const encodedTitle = encodeURIComponent(walk.data.title);
const mapApiKey = import.meta.env.PUBLIC_OS_MAPS_API_KEY ?? "";
const estimatedHours = walk.data.difficulty === "Hard"
  ? Math.max(3, Math.round(walk.data.distance / 2))
  : walk.data.difficulty === "Moderate"
    ? Math.max(2, Math.round(walk.data.distance / 2.4))
    : Math.max(1, Math.round(walk.data.distance / 2.8));
const stravaActivityMatch = walk.data.stravaRecord?.match(/activities\/(\d+)/i);
const stravaActivityId = stravaActivityMatch?.[1] ?? "";
const stravaEmbedUrl = stravaActivityId ? `https://www.strava.com/activities/${stravaActivityId}/embed` : "";
const stravaFlybyUrl = walk.data.stravaFlyby || "";
---

<BaseLayout
  title={`${walk.data.title} | ${settings.siteName}`}
  description={walk.data.summary}
  regions={regions}
  siteName={settings.siteName}
  tagline={settings.tagline}
>
  <div class="container page-grid">
    <article class="card article">
      <img src={walk.data.heroImage} alt={walk.data.title} />
      <h1>{walk.data.title}</h1>
      <p class="article-meta">
        {walk.data.location} 路 {walk.data.region} 路 {walk.data.distance} mi 路 {walk.data.difficulty} 路
        {walk.data.dogFriendly ? " Dog-friendly" : " Not dog-friendly"}
      </p>
      <p>{walk.data.summary}</p>

      <ul class="chip-list">
        {walk.data.tags.map((tag) => <li class="chip">{tag}</li>)}
      </ul>

      <section class="route-facts">
        <div><span>Distance</span><strong>{walk.data.distance} mi</strong></div>
        <div><span>Difficulty</span><strong>{walk.data.difficulty}</strong></div>
        <div><span>Estimated Time</span><strong>{estimatedHours} hrs</strong></div>
        <div><span>Dog Access</span><strong>{walk.data.dogFriendly ? "Dog-friendly" : "Lead only / restricted areas"}</strong></div>
      </section>

      <div class="map-panel" id="map"></div>
      <section class="card planning-strip">
        <div>
          <h2>Map And Navigation</h2>
          <p>Use OS mapping where possible, and keep an offline backup before setting off.</p>
        </div>
        <div class="planning-links">
          {walk.data.osMapsLink && <a class="button" href={walk.data.osMapsLink} target="_blank" rel="noreferrer">Open OS Maps Route</a>}
          <a class="button ghost-dark" href={walk.data.gpxDownload} target="_blank" rel="noreferrer">Download GPX</a>
        </div>
      </section>

      <section class="card dog-panel">
        <h2>Dog Trail Checklist</h2>
        <ul>
          <li>{walk.data.dogFriendly ? "Route is suitable for dogs with normal trail control." : "Route has sensitive sections. Use close lead control."}</li>
          <li>Check livestock and ground-nesting bird signage on the day.</li>
          <li>Carry water for your dog and avoid heat stress on exposed climbs.</li>
          <li>Pack a towel and paw check kit for wet rock and boggy exits.</li>
        </ul>
      </section>

      <section class="card">
        <h2>Route Notes</h2>
        <Content />
      </section>

      <section class="card">
        <h2>Strava Route and Flyby</h2>
        {stravaEmbedUrl ? (
          <div class="page-grid">
            <div>
              <h3>Route</h3>
              <iframe
                title={`Strava route for ${walk.data.title}`}
                src={stravaEmbedUrl}
                width="100%"
                height="480"
                style="border:0;"
                loading="lazy"
              ></iframe>
            </div>
            <div>
              <h3>Flyby</h3>
              {stravaFlybyUrl ? (
                <iframe
                  title={`Strava flyby for ${walk.data.title}`}
                  src={stravaFlybyUrl}
                  width="100%"
                  height="480"
                  style="border:0;"
                  loading="lazy"
                ></iframe>
              ) : (
                <p class="muted">No Flyby link is available for this walk.</p>
              )}
            </div>
          </div>
        ) : (
          <p class="muted">No Strava activity link is available for embedding yet.</p>
        )}
        <p class="muted">If embeds are blocked by Strava privacy settings, use the direct links below.</p>
      </section>

      <section class="card">
        <h2>Downloads and Links</h2>
        <p><strong>Parking:</strong> {walk.data.parking}</p>
        <p><strong>Mountain weather:</strong> <a href="https://www.mwis.org.uk/" target="_blank" rel="noreferrer">MWIS forecast</a></p>
        <p><strong>General weather:</strong> <a href="https://www.metoffice.gov.uk/" target="_blank" rel="noreferrer">Met Office</a></p>
        <p><a href={walk.data.gpxDownload} target="_blank" rel="noreferrer">Download GPX</a></p>
        <p><a href={walk.data.stravaRecord} target="_blank" rel="noreferrer">Strava Record</a></p>
        <p><a href={walk.data.stravaFlyby} target="_blank" rel="noreferrer">Strava Flyby</a></p>
      </section>

      <section class="card">
        <h2>Share This Walk</h2>
        <div class="share-row">
          <a class="button" href={`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`} target="_blank" rel="noreferrer">Facebook</a>
          <a class="button" href={`https://twitter.com/intent/tweet?url=${encodedUrl}&text=${encodedTitle}`} target="_blank" rel="noreferrer">X</a>
          <a class="button" href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`} target="_blank" rel="noreferrer">LinkedIn</a>
          <a class="button" href={`mailto:?subject=${encodedTitle}&body=${encodedUrl}`}>Email</a>
        </div>
      </section>
    </article>
  </div>

  <script type="application/ld+json" is:inline define:vars={{ walk: walk.data, pageUrl }}>
    {JSON.stringify({
      "@context": "https://schema.org",
      "@type": "TouristTrip",
      name: walk.title,
      description: walk.summary,
      url: pageUrl,
      touristType: "Walkers"
    })}
  </script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script
    is:inline
    define:vars={{
      lat: walk.data.routeMapLat,
      lng: walk.data.routeMapLng,
      zoom: walk.data.routeMapZoom,
      mapApiKey
    }}
  >
    const mapContainer = document.getElementById("map");
    if (mapContainer && window.L) {
      const map = window.L.map(mapContainer).setView([lat, lng], zoom);
      if (mapApiKey) {
        window.L.tileLayer("https://api.os.uk/maps/raster/v1/zxy/Outdoor_3857/{z}/{x}/{y}.png?key={accessToken}", {
          accessToken: mapApiKey,
          maxZoom: 18,
          attribution: "&copy; Ordnance Survey"
        }).addTo(map);
      } else {
        window.L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 18,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
      }
      window.L.marker([lat, lng]).addTo(map);
    }
  </script>
</BaseLayout>


