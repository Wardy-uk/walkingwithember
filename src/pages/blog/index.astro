---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getAllBlogs, getRegions, getSiteSettings } from "../../lib/content";

const settings = await getSiteSettings();
const regions = await getRegions();
const posts = await getAllBlogs();
---

<BaseLayout
  title={`${settings.siteName} | Blog`}
  description="Seasonal tips, walk reports, and practical outdoor planning notes."
  regions={regions}
  siteName={settings.siteName}
  tagline={settings.tagline}
>
  <div class="container page-grid">
    <section class="hero">
      <h1>Blog</h1>
      <p>Stories and planning tips from recent days on the trail.</p>
    </section>
    <section class="card-grid">
      {posts.map((post) => (
        <article class:list={["entry-card", post.data.draft && "admin-draft-only", post.data.draft && "hidden"]}>
          <a href={post.data.draft ? `/preview/blog/${post.slug}/` : `/blog/${post.slug}/`} target={post.data.draft ? "_blank" : undefined} rel={post.data.draft ? "noreferrer" : undefined}>
            <img src={post.data.coverImage} alt={post.data.title} loading="lazy" />
          </a>
          <div class="entry-card-body">
            <h2><a href={post.data.draft ? `/preview/blog/${post.slug}/` : `/blog/${post.slug}/`} target={post.data.draft ? "_blank" : undefined} rel={post.data.draft ? "noreferrer" : undefined}>{post.data.title}</a></h2>
            <p class="muted">{post.data.author} · {post.data.publishDate.toLocaleDateString("en-GB")}{post.data.draft ? " · Draft" : ""}</p>
            <p>{post.data.excerpt}</p>
          </div>
        </article>
      ))}
    </section>
  </div>

  <script is:inline>
    const draftBlocks = Array.from(document.querySelectorAll(".admin-draft-only"));

    function revealAdminDrafts() {
      draftBlocks.forEach((el) => el.classList.remove("hidden"));
    }

    if (window.netlifyIdentity) {
      try {
        window.netlifyIdentity.on("init", (user) => {
          if (user) revealAdminDrafts();
        });
        window.netlifyIdentity.on("login", revealAdminDrafts);
        window.netlifyIdentity.init();
        if (window.netlifyIdentity.currentUser()) revealAdminDrafts();
      } catch {}
    }
  </script>
</BaseLayout>

